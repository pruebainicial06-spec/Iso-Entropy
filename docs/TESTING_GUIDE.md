# ðŸ§ª Test Guide - Concrete Audit

## Objective
Validate that the ISO-ENTROPY system correctly executes the concrete audit with Markdown report generation in the `CONCLUDE` phase.

---

## Test Flow

### Step 1: Run Audit
```bash
python app.py
```

### Step 2: Configure Parameters in Streamlit
```
Volatility: High
Rigidity: High
Financial Buffer: 3 months
```

### Step 3: Observe Logs

The agent should show a flow like:

```
ðŸš€ STARTING AUTONOMOUS AGENT GEMINI 3 PRO
ðŸ“Š Calibration: High volatility, High rigidity, 3 months buffer

============================================================
ðŸ§  THINKING CYCLE #1
ðŸ” FSM_PHASE: ORIENT
============================================================

[... Cycles of ORIENT â†’ VALIDATE â†’ STRESS ...]

ðŸ FSM has transitioned to CONCLUDE. Generating final report.

ðŸ“„ GENERATING FINAL AUDIT REPORT (CONCLUDE PHASE)...
```

---

## Verification Points

### 1. CONCLUDE Phase Detection âœ…
**Expected signal in logs:**
```
ðŸ FSM has transitioned to CONCLUDE. Generating final report.
```

### 2. LLM Call in CONCLUDE âœ…
**Expected signal in logs:**
```
ðŸ“„ GENERATING FINAL AUDIT REPORT (CONCLUDE PHASE)...
```

### 3. Markdown Format in Report âœ…
**Expected structure in the final report:**
```markdown
### [Critical Failure Point]
...quantitative content...

### [Survival Horizon]
...estimation in cycles...

### [Actionable Mitigation]
...concrete proposal...
```

### 4. Enriched Telemetry âœ…
**Verify in LLM decision logs:**
- `theta_max_range`: Should show range of $H(C)$
- `entropy_debt_accumulated`: Should show numerical value
- `last_theta_max`: Should show last value

### 5. Report Integration âœ…
**In the final Streamlit output:**
- Should include "ðŸ“‹ Report Generated by Auditor (Gemini 3 Pro)" section
- Should contain the three sections: Critical Failure Point, Survival Horizon, Actionable Mitigation

---

## Test Case 1: Stable System

**Parameters:**
- Volatility: Low
- Rigidity: Low
- Buffer: 12 months

**Expectation:**
- FSM reaches CONCLUDE quickly
- Critical Failure Point: No critical point detected (stable system)
- Survival Horizon: Indefinite or very long
- Actionable Mitigation: Maintain current configuration

---

## Test Case 2: Fragile System

**Parameters:**
- Volatility: High
- Rigidity: High
- Buffer: 1 month

**Expectation:**
- FSM reaches CONCLUDE after several cycles
- Critical Failure Point: Identifies cycle and value of $H(C)$ where collapse is likely
- Survival Horizon: Limited number of cycles
- Actionable Mitigation: Increase capacity K or reduce volatility

---

## Test Case 3: Mock Mode

**Configuration (no API key):**
```bash
# No GEMINI_API_KEY in .env
python app.py
```

**Expectation:**
- The system works in mock mode
- Generates a predefined report without real calls to the LLM
- Logs show "Mock mode" and "Mock: System reached critical failure point"

---

## Troubleshooting

### Problem: "FSM does not reach CONCLUDE"
**Solution:**
- Check `fsm.py` to ensure the FSM transitions to CONCLUDE
- Verify that `allow_simulation()` returns False after CONCLUDE
- Increase MAX_ITERATIONS if necessary

### Problem: "Poorly formatted Markdown report"
**Solution:**
- Verify that the LLM receives the CONCLUDE prompt correctly
- Validate that `prompt_templates.py` has the expected Markdown format
- Check logs to see the exact response from the LLM

### Problem: "Telemetry does not include theta_max"
**Solution:**
- Verify that `calculate_collapse_threshold()` in `physics.py` is executed
- Ensure that the result is saved in `full_parameters`
- Check `telemetry.py` to validate extraction

---

## Metrics to Record

After each test, record:

| Metric | Value |
|---------|-------|
| Volatility | ... |
| Rigidity | ... |
| Buffer (months) | ... |
| Cycles executed | ... |
| Maximum collapse rate | ... |
| FSM final phase | ... |
| Report generated (Yes/No) | ... |
| Correct format (Yes/No) | ... |
| Total time (sec) | ... |

---

## Final Validation Checklist

- [ ] CONCLUDE phase is activated correctly
- [ ] LLM generates response in Markdown format
- [ ] Three sections present: Critical Failure Point, Survival Horizon, Actionable Mitigation
- [ ] Telemetry includes theta_max and entropy_debt_accumulated
- [ ] Final report integrates LLM content
- [ ] Mock mode works without API key
- [ ] Experiment table is displayed correctly
- [ ] No Python syntax errors
- [ ] Logs are informative and detailed

---

## Resources

- **Main File:** `agent.py` (`audit_system` method)
- **Templates:** `prompt_templates.py` (`build_prompt_for_phase` function)
- **Telemetry:** `telemetry.py` (`build_llm_signal` function)
- **FSM:** `fsm.py` (verify transitions to CONCLUDE)
- **Physics:** `physics.py` (verify `calculate_collapse_threshold`)

---

## Notes

1. **Compressed State:** If compression is activated (> 3 cycles), telemetry is simplified. This is normal.
2. **Token Optimization:** The thinking level is kept "low" to optimize API costs.
3. **Cache:** Prompts are cached to avoid duplicates. This does not affect the final audit.

---

**Last Updated:** January 15, 2026
